# 8μ£Όμ°¨ - AOP3

λ…Έμ… λ§ν¬ : [8μ£Όμ°¨ - AOP3](https://www.notion.so/8-AOP3-14b6873728d0801286f3f5e64084ba32?pvs=21) 

## νΈλμ­μ… μ •μ : TransactionDefinition

TransacitonDefinition μΈν„°νμ΄μ¤λ” νΈλμ­μ… λ™μ‘λ°©μ‹μ— μν–¥μ„ μ¤„ μ μλ” λ„¤ κ°€μ§€ μ†μ„±μ„ μ •μν•λ‹¤

1. **νΈλμ­μ… μ „ν** : μ΄λ―Έ μ§„ν–‰ μ¤‘μΈ νΈλμ­μ…μ΄ μλ” / μ—†λ” κ²½μ° λ™μ‘λ°©μ‹μ„ κ²°μ •ν•λ” λ°©μ‹
    - **PROPAGATION_REQUIRED**
        - μ§„ν–‰ μ¤‘μΈ νΈλμ­μ…μ΄ **μμΌλ©΄ β†’ μ°Έμ—¬**
            - μ¤‘κ°„μ— μμ™Έκ°€ λ°μƒν•λ©΄ μ°Έμ—¬ μ¤‘μΈ μ½”λ“κ°€ μ „λ¶€ λ΅¤λ°±
        - μ§„ν–‰ μ¤‘μΈ νΈλμ­μ…μ΄ **μ—†μΌλ©΄ β†’ μƒλ΅ μ‹μ‘**
        - **Default**TransactionDefinitionμ μ „νμ†μ„±
    - **PROPAGATION_REQUIRES_NEW**
        - **ν•­μƒ μƒλ΅μ΄ νΈλμ­μ…μ„ μ‹μ‘**
        - **λ…λ¦½μ μΈ νΈλμ­μ…**μ΄ λ³΄μ¥λμ–΄μ•Ό ν•λ” κ²½μ°μ— μ‚¬μ©
    - **PROPAGATION_NOT_SUPPORTED**
        - **νΈλμ­μ… μ—†μ΄ λ™μ‘**
        - νΉμ •ν• λ©”μ†λ“λ§ νΈλμ­μ… μ μ©μ—μ„ μ μ™Έν•΄μ•Ό ν•λ” κ²½μ°μ— μ‚¬μ© : λ¨λ“  λ©”μ†λ“μ— AOPκ°€ μ μ©λκ² μ„¤μ • + νΈλμ­μ…μ΄ μ—†μ–΄μ•Ό ν•λ” λ¶€λ¶„μ—λ§ μ „νμ†μ„±μ„ λ‹¤λ¥΄κ² μ„¤μ •ν•λ” λ°©μ‹
2. **μ ν•μ‹κ°„ :** νΈλμ­μ… μν–‰ μ ν•μ‹κ°„ μ„¤μ •
    - **Default**TransactionDefinition : **μ ν•μ‹κ°„ μ—†μ**
    - νΈλμ­μ…μ„ μ§μ ‘ μ‹μ‘ν•  μ μλ” κ²½μ°(PROPAGATION_REQUIRED,  PROPAGATION_REQUIRES_NEW)μ—λ§ μλ―Έκ°€ μλ‹¤
3. **μ½κΈ°μ „μ©** : νΈλμ­μ… λ‚΄μ—μ„ λ°μ΄ν„°λ¥Ό μ΅°μ‘ν•λ” μ‹λ„λ¥Ό λ§‰μ„ μ μλ‹¤
    - λ°μ΄ν„° μ•΅μ„Έμ¤ κΈ°μ μ— λ”°λΌ μ„±λ¥ν–¥μƒμ΄ μμ„ μ μλ‹¤
4. **κ²©λ¦¬μμ¤€ :** μ„±λ¥ ν–¥μƒμ„ μ„ν•΄ μ—¬λ¬ κ°μ νΈλμ­μ…μ΄ λ™μ‹μ— μ‹¤ν–‰λκ² ν•λ©΄μ„λ„ μ μ ν• κ²©λ¦¬μμ¤€μ„ μ΅°μ •ν•μ—¬ λ¬Έμ κ°€ λ°μƒν•μ§€ μ•κ² μ μ–΄ν•λ” κ²ƒμ΄ ν•„μ”ν•λ‹¤
    - **Default**TransactionDefinitionμ κ²©λ¦¬μμ¤€ = **ISOLATION_DEFAULT** : DBμ λ””ν΄νΈλ¥Ό λ”°λ¥Έλ‹¤

---

## TransactionInterceptor

νΈλμ­μ… κ²½κ³„μ„¤μ • μ–΄λ“λ°”μ΄μ¤λ΅ μ‚¬μ©ν•  μ μμΌλ©°, **νΈλμ­μ… μ •μλ¥Ό λ©”μ†λ“ μ΄λ¦„ ν¨ν„΄μ„ μ΄μ©ν•΄ λ‹¤λ¥΄κ² μ •μν•  μ μλ‹¤**

μΈν„°μ…‰ν„°λ” λ‘ κ°€μ§€ ν”„λ΅νΌν‹°λ¥Ό κ°–λ”λ‹¤

- PlatformTransacitonManager
- **Properties - transactionAttributes**
    - **νΈλμ­μ… λ„¤ κ°€μ§€ κΈ°λ³Έν•­λ©(μ „ν, κ²©λ¦¬, μ ν•μ‹κ°„, μ½κΈ°μ „μ©) + rollbackOn λ©”μ†λ“ (λ΅¤λ°± λ°μƒμ‹ν‚¬ μμ™Έ μ •μ)**

- μ¤ν”„λ§μ΄ μ κ³µν•λ” TransacitonInterceptorμ μμ™Έμ²λ¦¬ λ°©μ‹
    1. **λ°νƒ€μ„**μμ™Έ β†’ νΈλμ­μ… **λ΅¤λ°±** / **μ²΄ν¬μμ™Έ** β†’ **μ»¤λ°‹** (μμ™Έμ‚¬ν•­μ΄ μ•„λ‹ λΉ„μ¦λ‹μ¤ λ΅μ§μ ν• λ¶€λ¶„μΌλ΅ ν•΄μ„)
    2. rollbackOn()μ— μ§μ ‘ μ›ν•λ” λ°©μ‹μΌλ΅ μ •μ

### λ©”μ†λ“μ΄λ¦„ν¨ν„΄ μ΄μ©ν• νΈλμ­μ… μ†μ„± μ§€μ •

**transactionAttributes : ν‚¤-κ°’μ μ»¬λ ‰μ… : λ©”μ†λ“ν¨ν„΄ - νΈλμ­μ…μ†μ„±**

<aside>
π’΅

**PROPAGATION_NAME, ISOLATION_NAME, READ_ONLY, TIMEOUT_NNNN, -Exception1, +Exception2**

- **ν•„μν•­λ© : μ „νμ†μ„±**
- μƒλµ μ‹ DefaultTransactionDefinitionμ λ””ν΄νΈ μ†μ„±μ΄ λ¶€μ—¬λλ‹¤
- -Exception : μ²΄ν¬μμ™Έμ§€λ§ λ΅¤λ°± λ€μƒμΌλ΅ μ¶”κ°€ν•  ν•­λ©
- +Exception : λ°νƒ€μ„μμ™Έμ§€λ§ λ΅¤λ°± λ€μƒμ—μ„ μ‚­μ ν•  ν•­λ©
</aside>

---

### ν¬μΈνΈκ²ƒ - νΈλμ­μ…μ†μ„± μ μ© μ „λµ

1. **νΈλμ­μ… ν¬μΈνΈμ»· ν‘ν„μ‹μ€ νƒ€μ…ν¨ν„΄, λΉ μ΄λ¦„μ„ μ‚¬μ©ν•λ‹¤**
    - νƒ€κΉƒ ν΄λμ¤μ **λ©”μ†λ“λ” μ „λ¶€ νΈλμ­μ… μ μ© ν›„λ³΄**λ΅ μ‚¬μ©ν•μ
    - λΉ„μ¦λ‹μ¤ λ΅μ§μ ν΄λμ¤λΌλ©΄ λ©”μ†λ“ λ‹¨μ„λ΅ μ„Έλ°€ν•κ² ν¬μΈνΈμ»·μ„ μ •μν•΄ μ£Όλ” κ²ƒ λ³΄λ‹¤λ”
    - **νΈλμ­μ… κ²½κ³„λ΅ μ‚Όμ„ ν¨ν‚¤μ§€λ¥Ό ν†µμ§Έλ΅ μ„ νƒν•κ±°λ‚, ν΄λμ¤μ ν¨ν„΄μ„ ν‘ν„μ‹μΌλ΅ μ„¤μ •**ν•μ
        - ν΄λμ¤λ³΄λ‹¤λ” μΈν„°νμ΄μ¤ νƒ€μ…μ„ κΈ°μ¤€μΌλ΅ νƒ€μ… ν¨ν„΄μ„ μ μ©ν•μ
2. **κ³µν†µλ λ©”μ†λ“ μ΄λ¦„ κ·μΉ™μ„ ν†µν•΄ μµμ†ν•μ νΈλμ­μ… μ–΄λ“λ°”μ΄μ¤ μ†μ„±μ„ μ •μν•λ‹¤**
    - λ„λ¬΄ λ§μ€ μ„Έλ¶€μ μΈ νΈλμ­μ…μ„ μ •μν•λ” κ²ƒλ³΄λ‹¤λ”
    - **κΈ°μ¤€μ΄ λλ” λ‡ κ°€μ§€ νΈλμ­μ… μ†μ„±μ„ μ •μν•κ³  + μ μ ν• λ©”μ†λ“ λ…λ…κ·μΉ™μ„ μ‚¬μ©ν•΄μ„ : ν•λ‚μ μ–΄λ“λ°”μ΄μ¤λ΅ λ€λ¶€λ¶„μ μ„λΉ„μ¤ λΉ νΈλμ­μ… μ†μ„±μ„ μ§€μ •**ν•μ
        - μμ™Έμ μΈ μ¤λΈμ νΈμ κ²½μ°μ—λ§ μ–΄λ“λ°”μ΄μ¤, ν¬μΈνΈμ»·μ„ μƒλ΅­κ² μ¶”κ°€ν•μ
3. **ν”„λ΅μ‹ λ°©μ‹μ AOPλ” κ°™μ€ νƒ€κΉƒ μ¤λΈμ νΈ λ‚΄μ λ©”μ†λ“λ¥Ό νΈμ¶ν•  λ•λ” μ μ©λμ§€ μ•λ”λ‹¤**
    - νƒ€κΉƒ μ¤λΈμ νΈ λ‚΄λ¶€μ—μ„μ λ©”μ†λ“ νΈμ¶μ€ ν”„λ΅μ‹λ¥Ό κ±°μΉμ§€ μ•κΈ° λ•λ¬Έμ— λ¶€κ°€κΈ°λ¥μ΄ μ μ©λμ§€ μ•λ”λ‹¤
        - μƒλ΅μ΄ νΈλμ­μ… μ†μ„±μ„ λ¶€μ—¬ν•μ§€ λ»ν•λ‹¤
    - ν”„λ΅μ‹κ°€ μ•„λ‹ AspectJμ™€ κ°™μ€ νƒ€κΉƒμ λ°”μ΄νΈμ½”λ“λ¥Ό μ§μ ‘ μ΅°μ‘ν•λ” λ°©μ‹μ AOP κΈ°μ μ„ μ μ©ν•μ
4. **νΈλμ­μ… κ²½κ³„μ„¤μ •μ μΌμ›ν™”**
    - **νΉμ • κ³„μΈµμ κ²½κ³„ - νΈλμ­μ… κ²½κ³„λ¥Ό μΌμΉ**μ‹ν‚¤λ” κ²ƒμ΄ λ°”λμ§ν•λ‹¤
        - **μ„λΉ„μ¤ κ³„μΈµ**μ μ¤λΈμ νΈκ°€ νΈλμ­μ… κ²½κ³„λ¥Ό λ¶€μ—¬ν•κΈ° κ°€μ¥ μ μ ν•λ‹¤
    - μ„λΈμ‹ κ³„μΈµμ„ κ²½κ³„λ΅ μ„¤μ •ν–λ‹¤λ©΄
        - λ‹¤λ¥Έ κ³„μΈµ, λ¨λ“μ—μ„ DAOμ— μ§μ ‘ μ ‘κ·Όν•λ” κ²ƒμ„ μ°¨λ‹¨ν•΄μ•Ό ν•λ‹¤
        - DAOκ°€ μ κ³µν•λ” **μ£Όμ” κΈ°λ¥μ€ μ„λΉ„μ¤ κ³„μΈµμ— μ„μ„ λ©”μ†λ“**λ¥Ό λ§λ“¤μ
        - **DAOμ— μ ‘κ·Όν•  λ•λ” μ„λΉ„μ¤ κ³„μΈµμ„ κ±°μΉλ„λ΅** ν•λ” κ²ƒμ΄ λ°”λμ§ν•λ‹¤

- UserServiceμ— μ§μ ‘ μ μ©

```java
public interface UserService {
    void upgradeLevels(); 
    User get(String id);
    List<User> getAll();
    void deleteAll(); 
    void add(User user);
    void update(User user);
}

// ...
// κµ¬ν„μ²΄
// DAOλ΅ μ„μ„ν•λ„λ΅ λ§λ“ λ‹¤

@Override
public User get(String id) { return userDao.get(id); }
@Override
public List<User> getAll() { return userDao.getAll(); }

@Override
public void deleteAll() { userDao.deleteAll(); }

@Override
public void update(User user) { userDao.update(user); }
```

```java
// μ„λΉ„μ¤ λΉμ— μ μ©λλ” ν¬μΈνΈμ»· ν‘ν„μ‹ λ“±λ΅
<aop:config>
  <aop:advisor advice-ref="transactionAdvice" pointcut="bean(*Service)" />
</aop:config>
```

---

## μ• λ…Έν…μ΄μ… νΈλμ­μ… μ†μ„±κ³Ό ν¬μΈνΈμ»· : @Transactional

- μ§μ ‘ νƒ€κΉƒμ— νΈλμ­μ… μ†μ„±μ •λ³΄λ¥Ό κ°€μ§„ μ• λ…Έν…μ΄μ…μ„ μ§€μ •ν•μ—¬ λ” μ„Έλ°€ν•κ² νΈλμ­μ… μ†μ„±μ„ λ¶€μ—¬ν•  μ μλ‹¤

```java
@Target({ElementType.TYPE, ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
@Inherited
@Documented
public @interface Transactional {
	@AliasFor("transactionManager")
	String value() default "";
	@AliasFor("value")
	String transactionManager() default "";
	String[] label() default {};
	Propagation propagation() default Propagation.REQUIRED;
	Isolation isolation() default Isolation.DEFAULT;
	int timeout() default TransactionDefinition.TIMEOUT_DEFAULT;
	String timeoutString() default "";
	boolean readOnly() default false;
	Class<? extends Throwable>[] rollbackFor() default {};
	String[] rollbackForClassName() default {};
	Class<? extends Throwable>[] noRollbackFor() default {};
	String[] noRollbackForClassName() default {};

}
```

- @Target({ElementType.TYPE, ElementType.METHOD}) : **μ• λ…Έν…μ΄μ… μ‚¬μ© λ€μƒ** μ§€μ •
    - **λ©”μ†λ“, νƒ€μ…(ν΄λμ¤, μΈν„°νμ΄μ¤)**μ— μ§€μ • κ°€λ¥
- @Retention(RetentionPolicy.RUNTIME) : μ• λ…Έν…μ΄μ… μ •λ³΄ μ μ§€ μ§€μ •
    - λ°νƒ€μ„μ—λ„ μ• λ…Έν…μ΄μ… μ •λ³΄λ¥Ό μ–»μ„ μ μλ‹¤
- value, propagation, isolation, timeout~ : νΈλμ­μ… μ†μ„±μ λ¨λ“  ν•­λ©μ„ μ—λ¦¬λ¨ΌνΈλ΅ μ§€μ •ν•  μ μλ‹¤
- λ©”μ†λ“, ν΄λμ¤, μΈν„°νμ΄μ¤μ— μ‚¬μ©ν•  μ μμΌλ©°, μ• λ…Έν…μ΄μ…μ„ νΈλμ­μ… μ†μ„±μ •λ³΄λ΅ μ‚¬μ©ν•λ©΄ μ¤ν”„λ§μ€ **@Transactionalμ΄ λ¶€μ—¬λ λ¨λ“  μ¤λΈμ νΈλ¥Ό μλ™μΌλ΅ νƒ€κΉƒ μ¤λΈμ νΈλ΅ μΈμ‹**ν•λ‹¤
β†’ μ‚¬μ© ν¬μΈνΈμ»· : TransactionAttributeSourcePointcut

### νΈλμ­μ… μ†μ„±μ„ μ΄μ”ν•λ” ν¬μΈνΈμ»·

μ• λ…Έν…μ΄μ…μ„ μ‚¬μ©ν–μ„ λ•μ μ–΄λ“λ°”μ΄μ €μ λ™μ‘λ°©μ‹

- **μ–΄λ“λ°”μ΄μ¤** : @Transactional μ• λ…Έν…μ΄μ…μ μ—λ¦¬λ©νΈμ—μ„ νΈλμ­μ… μ†μ„±μ„ κ°€μ Έμ¤λ” AnnotationTransactionAttributeSourceλ¥Ό μ‚¬μ©
    - μ¦‰ μ• λ…Έν…μ΄μ…μ— λ‹΄κ²¨μλ” νΈλμ­μ… μ†μ„±μ •λ³΄λ¥Ό μ‚¬μ©ν•λ‹¤
- **ν¬μΈνΈμ»·** : TransactionAttributeSourcePointcut : μ†μ„±μ΄ λ¶€μ—¬λ λ€μƒμ„ ν™•μΈν•λ‹¤

**β‡’ νΈλμ­μ… λ¶€κ°€κΈ°λ¥ μ μ© λ‹¨μ„ : λ©”μ†λ“**

- λ©”μ†λ“λ§λ‹¤ μ• λ…Έν…μ΄μ…μ„ λ¶€μ—¬ν•μ—¬ μ†μ„±μ„ μ§€μ •ν•λ©΄
    - μ„Έλ¶„ν™”λ μ μ—°ν• μ†μ„±μ μ–΄κ°€ κ°€λ¥ν•μ§€λ§
    - μ½”λ“λ” μ§€μ €λ¶„ν•΄μ§€κ³ , λ™μΌν• μ†μ„±μ •λ³΄λ¥Ό κ°€μ§„ μ• λ…Έν…μ΄μ…μ„ λ°λ³µμ μΌλ΅ λ©”μ†λ“λ§λ‹¤ λ¶€μ—¬ν•κ² λλ‹¤

### λ€μ²΄ μ •μ±…

- @Transactional μ• λ…Έν…μ΄μ…μ 4λ‹¨κ³„ λ€μ²΄μ •μ±…
- λ©”μ†λ“ μ μ© μ†μ„± μμ„ : **νƒ€κΉƒλ©”μ†λ“ β†’ νƒ€κΉƒν΄λμ¤ β†’ μ„ μ–Έλ©”μ†λ“ β†’ μ„ μ–Ένƒ€μ…**(ν΄λμ¤, μΈν„°νμ΄μ¤)
    - μμ„λ€λ΅ μ• λ…Έν…μ΄μ… μ μ© μ—¬λ¶€λ¥Ό ν™•μΈν•κ³ , **κ°€μ¥ λ¨Όμ € λ°κ²¬λλ” μ†μ„±μ •λ³΄λ¥Ό μ‚¬μ©**ν•λ‹¤
    - λ°λ€λ΅ κ³µν†µμΌλ΅ **μ μ©λλ” λ²”μ„κ°€ κ°€μ¥ ν° μμ„λ΅λ” : μ„ μ–Έ > μ„ μ–Έλ©”μ†λ“ > νƒ€κΉƒν΄λμ¤ > νƒ€κΉƒν΄λμ¤**
    - μ¦‰ ν° λ²”μ„μ— μ• λ…Έν…μ΄μ…μ„ λ¶€μ—¬ν•λ©΄, κ·Έ ν•μ„μ—λ” ν•΄λ‹Ή μ†μ„±μ΄ κ³µν†µμ μΌλ΅ μ μ©λλ‹¤
- λ”°λΌμ„ **λ” ν° λ²”μ„μ— @Transactionalμ„ λ¶€μ—¬ν•κ³ , κ³µν†µ μ†μ„±μ„ λ”°λ¥΄μ§€ μ•λ” νΉμ • λ©”μ†λ“μ—λ§ μ¶”κ°€λ΅ νΈλμ­μ…μ„ λ¶€μ—¬**ν•μ—¬ μ¤‘λ³µμ„ λ°©μ§€ν•μ
β‡’ **νƒ€κΉƒ ν΄λμ¤μ— @Transactionalμ„ λ‘κ³ , κ³µν†µ μ†μ„±μ„ λ”°λ¥΄μ§€ μ•λ” λ©”μ†λ“μ— λ€ν•΄μ„λ§ λ©”μ†λ“ λ λ²¨μ— λ‹¤μ‹ @Transactionalμ„ λ¶™μ΄λ” λ°©λ²•μ„ κ¶μ¥**ν•λ‹¤
- ν”„λ΅μ‹ λ°©μ‹μ AOPκ°€ μ•„λ‹ λ°©μ‹μΌλ΅ νΈλμ­μ…μ„ μ μ©ν•λ©΄, μΈν„°νμ΄μ¤μ— λ‘” @Transactionalμ€ λ¬΄μ‹λκΈ° λ•λ¬Έμ— ν΄λμ¤μ— λ‘λ” κ²ƒμ„ κ¶μ¥ν•λ‹¤
    - μΈν„°νμ΄μ¤ λ λ²¨μ— λ‘λ©΄ κµ¬ν„ ν΄λμ¤κ°€ λ°”λ€μ–΄λ„ μ†μ„±μ„ μ μ§€ν•  μ μλ‹¤λ” μ¥μ μ΄ μλ‹¤

- μ μ© μ½”λ“

```java
@Transactional
public interface UserService {
		// λ©”μ†λ“ λ λ²¨μ— λ¶€μ—¬λ μ• λ…Έν…μ΄μ…μ΄ μ—†μΌλ―€λ΅
		// νƒ€μ…μ— λ¶€μ—¬λ μ• λ…Έν…μ΄μ…μ μ†μ„±μ΄ μ μ©λλ‹¤
    void upgradeLevels();
    void add(User user);
    void deleteAll();
    void update(User user);
    
    // λ©”μ†λ“ λ λ²¨μ—μ„ μ„¤μ •λ μ†μ„±μ„ λ”°λ¥Έλ‹¤
    @Transactional(readOnly = true)
    User get(String id);
    @Transactional(readOnly = true)
    List<User> getAll();
}
```

---

## μ„ μ–Έμ  νΈλμ­μ…κ³Ό νΈλμ­μ… μ „ν μ†μ„±

- ν”„λ΅κ·Έλ¨μ— μν• νΈλμ­μ… : κ°λ³„ λ°μ΄ν„° κΈ°μ μ νΈλμ­μ… APIλ¥Ό μ‚¬μ©ν•΄ μ§μ ‘ μ½”λ“ μ•μ—μ„ μ‚¬μ©ν•λ” λ°©λ²•
- **μ„ μ–Έμ  νΈλμ­μ…** : AOPλ¥Ό μ΄μ©ν•΄ μ½”λ“ μ™Έλ¶€μ—μ„ νΈλμ­μ…μ κΈ°λ¥μ„ λ¶€μ—¬ν•΄μ£Όκ³  μ†μ„±μ„ μ§€μ •ν•  μ μκ² ν•λ” λ°©λ²•
- μ„ μ–Έμ  νΈλμ­μ…μ μ¥μ 
    - **λ…μμ μΌλ΅ νΈλμ­μ… λ‹¨μ„**κ°€ λ  μλ„ μκ³ , **λ‹¤λ¥Έ νΈλμ­μ…μ μΌλ¶€**λ΅ μ°Έμ—¬ν•  μλ„ μλ‹¤
        - μ¦‰ **μ¤μ¤λ΅ νΈλμ­μ… κ²½κ³„λ¥Ό μ„¤μ •**ν•  μλ„ μμΌλ©°, λ‹¤λ¥Έ λ©”μ†λ“μ—μ„ λ§λ“¤μ–΄μ§„ **νΈλμ­μ…μ κ²½κ³„ μ•μ— ν¬ν•¨**λ  μλ„ μλ‹¤
    - λ”°λΌμ„ λ‹¤λ¥Έ λ©”μ†λ“μ—μ„ **νΈμ¶λμ–΄ μ‚¬μ©**λ  μ μμΌλ©°
    - λ‹¤λ¥Έ λΉ„μ¦λ‹μ¤ νΈλμ­μ…μ—μ„ μ‚¬μ©λλ”λΌλ„ **λ¶ν•„μ”ν• μ½”λ“μ¤‘λ³µμ΄ λ°μƒν•μ§€ μ•λ”λ‹¤**

---

## νΈλμ­μ… λ™κΈ°ν™”μ™€ ν…μ¤νΈ

νΈλμ­μ… μ „νμ κΈ°μ μ  κΈ°λ° : **AOP + νΈλμ­μ… μ¶”μƒν™”**

β†’ νΈλμ­μ… μ¶”μƒν™”μ κΈ°μ μ  κΈ°λ° : **νΈλμ­μ… λ§¤λ‹μ € + νΈλμ­μ… λ™κΈ°ν™”**

- κµ¬μ²΄μ μΈ νΈλμ­μ… κΈ°μ κ³Ό μƒκ΄€μ—†μ΄ μΌκ΄€λ νΈλμ­μ… μ μ–΄κ°€ κ°€λ¥ν•΄μ§„λ‹¤
- νΈλμ­μ… μ •λ³΄λ¥Ό λ³΄κ΄€ν–λ‹¤κ°€ DAOμ—μ„ κ³µμ ν•μ—¬ μ‚¬μ©ν•  μ μκ² λλ‹¤

### **< ν”„λ΅κ·Έλ¨μ— μν• νΈλμ­μ… λ°©μ‹**μ„ μ΄μ©ν• νΈλμ­μ… λ™κΈ°ν™” >

λ¨λ‘ κ°™μ€ νΈλμ­μ… μ•μ—μ„ λμ•„κ°€κ² λ§λ“λ” μμ‹

```java
@Test(expected = UncategorizedSQLException.class)
public void transactionSync() {
    DefaultTransactionDefinition transactionDefinition = new DefaultTransactionDefinition();
    transactionDefinition.setReadOnly(true);
    TransactionStatus txStatus = transactionManager.getTransaction(transactionDefinition);

		// μ•μ—μ„ λ§λ“¤μ–΄μ§„ νΈλμ­μ…μ— μ°Έμ—¬ν•λ‹¤
		
		// νΈλμ­μ…μ readOnlyλ¥Ό μ„λ°ν–μΌλ―€λ΅ μ—λ¬ λ°μƒ
    userService.deleteAll();

    userService.add(users.get(0));
    userService.add(users.get(1));

    transactionManager.commit(txStatus);
}
```

- λ¨λ‘ κ°™μ€ νΈλμ­μ…μΌλ΅ ν†µν•©ν•λ” λ°©λ²• : **λ©”μ†λ“κ°€ νΈμ¶λκΈ° μ „μ— νΈλμ­μ…μ΄ μ‹μ‘**λκ² ν•λ‹¤
    - μ „λ¶€ REQUIREDμ΄λ―€λ΅, μ΄λ―Έ μ‹μ‘λ νΈλμ­μ…μ΄ μλ‹¤λ©΄ ν†µν•©λκΈ° λ•λ¬Έ
- transactionManager.**getTransaction**(transactionDefinition)
    - **μƒλ΅μ΄ νΈλμ­μ… μ‹μ‘**
- **μ½κΈ°μ „μ©, μ ν•μ‹κ°„μ€ μ²μ μ‹μ‘λ νΈλμ­μ…μ μ†μ„±μΌλ΅ κ²°μ •**λλ‹¤
    - **μ΄ν›„μ— μ°Έμ—¬ν• νΈλμ­μ…μ μ†μ„±μ€ λ¬΄μ‹λλ‹¤**
    
    β†’ transactionDefinition.setReadOnly(true); μ΄λ―€λ΅ **userService.deleteAll(); λν• μ½κΈ°μ „μ© νΈλμ­μ…μ΄ μ μ©λ μƒνƒμ—μ„ μ§„ν–‰**λλ‹¤
    
    β†’ λ”°λΌμ„ deleteAll()μ—μ„ μ—λ¬κ°€ λ°μƒν•λ‹¤ : λ©”μ†λ“λ“¤μ΄ κ°™μ€ νΈλμ­μ…μ—μ„ λ™μ‘ν•κ³  μλ‹¤λ” ν…μ¤νΈ κ²€μ¦ μ™„λ£
    

### **< λ΅¤λ°± ν…μ¤νΈ >**

- ν…μ¤νΈ λ‚΄μ λ¨λ“  DB μ‘μ—…μ„ **ν•λ‚μ νΈλμ­μ… μ•μ—μ„ λ™μ‘ν•κ² ν•κ³ , ν…μ¤νΈκ°€ λλ‚λ©΄ λ¬΄μ΅°κ±΄ λ΅¤λ°±**
- λ³µμ΅ν• λ°μ΄ν„°λ¥Ό μ‚¬μ©ν•λ” ν…μ¤νΈμ—μ„λ” DB λ°μ΄ν„°, μƒνƒκ°€ λ§¤μ° μ¤‘μ”ν•λ‹¤
    - λ”°λΌμ„ **ν…μ¤νΈμ μμ„λ” λ³΄μ¥ν•  μ μ—†μΌλ©°, μ•μ„μ ν…μ¤νΈμ— μν•΄ μ¤€λΉ„ν• ν…μ¤νΈ λ°μ΄ν„°κ°€ λ°”λ€λ” μƒν™©**μ΄λΌλ©΄ ν•λ‚μ ν…μ¤νΈμ—μ„ **μ΅°μ‘ν• λ°μ΄ν„°λ¥Ό μ‹μ‘ν•κΈ° μ „ μƒνƒλ΅ λ§λ“¤κ³  λ§λ¬΄λ¦¬ ν•  μ μλ” λ΅¤λ°± ν…μ¤νΈκ°€ λ§¤μ° μ μ©**ν•λ‹¤
- λν• μ—¬λ¬ κ°λ°μκ°€ ν•λ‚μ κ³µμ© ν…μ¤νΈ DBλ¥Ό μ‚¬μ©ν•  μλ„ μλ‹¤

```java
@Test
public void transactionSync() {
    DefaultTransactionDefinition transactionDefinition = new DefaultTransactionDefinition();
    TransactionStatus txStatus = transactionManager.getTransaction(transactionDefinition);

		try {
			userService.add(users.get(0));
	    userService.add(users.get(1));
	    Assertions.assertEquals(2, userDao.getCount());
		} finally {
			transactionManager.rollback(txStatus);
		}
    
}
```

### < νΈλμ­μ… μ• λ…Έν…μ΄μ… : ν…μ¤νΈμ© >

**@Transactional**

- ν…μ¤νΈ μ½”λ“μ—λ„ @Transactional μ μ©μΌλ΅ νΈλμ­μ… κ²½κ³„λ¥Ό μλ™μΌλ΅ μ„¤μ •ν•  μ μλ‹¤
- ν΄λμ¤, λ©”μ†λ“ λ λ²¨μ— μ• λ…Έν…μ΄μ…μ„ λ¶€μ—¬ν•  μ μλ‹¤
- **μλ™μΌλ΅ λ΅¤λ°±**λλ‹¤
- λ΅¤λ°±μ— κ΄€λ ¨λ μ„¤μ •μ„ λ‹΄μ„ μ μ—†λ‹¤

**@Rollback**

- Transactionalμ²λΌ **νΈλμ­μ… κ²½κ³„μ„¤μ •μ΄ κ°€λ¥ν•λ©΄μ„ + λ΅¤λ°± κ΄€λ ¨ μ„¤μ •**μ„ λ‹΄μ„ μ μλ‹¤
- λ΅¤λ°± λ―Έμ μ© : @Rollback(false)
- **λ©”μ†λ“ λ λ²¨**μ—λ§ μ μ©ν•  μ μλ‹¤

**@TransactionConfiguration**

- **ν΄λμ¤ λ λ²¨μ— νΈλμ­μ…κ³Ό κ΄€λ ¨λ μ„¤μ •μ„ λ¶€μ—¬**ν•  μ μλ‹¤
- λ”°λΌμ„ ν…μ¤νΈ ν΄λμ¤μ λ¨λ“  λ©”μ†λ“μ— νΈλμ­μ…μ„ μ μ©ν•λ©΄μ„ + λ΅¤λ°±λμ§€ μ•κ² ν•λ ¤λ©΄ 
ν΄λμ¤ λ λ²¨μ— @TransactionConfiguration(defaultRollback=false) + λ©”μ†λ“ λ λ²¨μ— @Rollback